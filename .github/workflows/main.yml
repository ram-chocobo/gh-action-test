# 
# 최신 tag 참조하기: https://stackoverflow.com/a/22857288
# ssh에 shell script 실행하기: https://github.com/fifsky/ssh-action/blob/master/entrypoint.sh

name: Deploy master branch

on:
  push:
    branches: [main]
  release:
    types:
      - created

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Make deploy script
        run: |
          cat << EOF > shell.sh
          echo "=== pull master branch ==="
          # cd ${{ secrets.SSH_WORKING_DIRECTORY }}
          # git checkout master
          # git pull origin master
          # # 최신 tag를 이용할경우 git pull origin $(git describe --tags $(git rev-list --tags --max-count=1))
          
          echo "=== build backend ==="
          # cd backend
          # npm ci
          # npm run build
          # cd ..
          
          echo "=== build frontend ==="
          # cd frontend
          # npm ci
          # npm run build
          # cd ..
          
          echo "=== restart backend server ==="
          # forever stopall
          # forever start ./backend/dist/app.js
          
          echo "=== update nginx serve files ==="
          # rm -rf ${{ secrets.NGINX_DIRECTORY }}
          # cp ./frontend/dist ${{ secrets.NGINX_DIRECTORY }}
          EOF
      - name: Setting ssh agent and key
        run: |
          # mkdir -p ~/.ssh
          # eval `ssh-agent`
          # ssh-add - <<< "${{ secrets.SSH_PRIVATE_KEY }}"
      - name: Run script on ssh
        run: ssh -i ${{ secrets.SSH_PRIVATE_KEY }} -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} < shell.sh
      - name: Cleanup
        run: rm shell.sh
